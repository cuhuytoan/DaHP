# Frontend Development Rules for CMS Migration
# Reference: docs/migration-plan.md

## Overview
This file defines rules for developing the Next.js frontend that will replace
the Blazor Server-Side application and consume the .NET Core API.

## Project Structure

### Next.js Application Structure
```
cms-frontend/
├── src/
│   ├── app/                    # App Router (Next.js 13+)
│   │   ├── (admin)/           # Admin layout group
│   │   │   ├── dashboard/
│   │   │   ├── articles/
│   │   │   ├── products/
│   │   └── (public)/          # Public layout group
│   │       ├── page.tsx       # Home page
│   │       ├── articles/
│   │       └── products/
│   ├── components/
│   │   ├── ui/                # Reusable UI components
│   │   ├── forms/             # Form components
│   │   ├── layouts/           # Layout components
│   │   └── features/          # Feature-specific components
│   ├── hooks/                 # Custom React hooks
│   ├── lib/                   # Utility functions
│   ├── services/              # API service layer
│   ├── store/                 # State management
│   ├── types/                 # TypeScript types
│   └── utils/                 # Helper functions
├── public/
├── next.config.js
├── tailwind.config.js
└── package.json
```

## Technology Stack

### Core Dependencies
```json
{
  "dependencies": {
    "next": "^14.0.0",
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "@tanstack/react-query": "^5.0.0",
    "zustand": "^4.0.0",
    "axios": "^1.6.0",
    "react-hook-form": "^7.0.0",
    "zod": "^3.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^18.0.0",
    "typescript": "^5.0.0",
    "tailwindcss": "^3.0.0",
    "eslint": "^8.0.0",
    "prettier": "^3.0.0"
  }
}
```

### UI Component Library
- **shadcn/ui** - Modern component library built on Radix UI
- **Tailwind CSS** - Utility-first CSS framework
- **Lucide React** - Icon library

## State Management

### Global State (Zustand)
```typescript
// stores/auth.ts
interface AuthState {
  user: User | null;
  token: string | null;
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
  refreshToken: () => Promise<void>;
}

export const useAuthStore = create<AuthState>((set, get) => ({
  user: null,
  token: null,
  login: async (email, password) => {
    const response = await api.post('/auth/login', { email, password });
    set({ user: response.data.user, token: response.data.token });
  },
  logout: () => {
    set({ user: null, token: null });
    localStorage.removeItem('token');
  },
  refreshToken: async () => {
    const response = await api.post('/auth/refresh');
    set({ token: response.data.token });
  }
}));
```

### Server State (TanStack Query)
```typescript
// hooks/useArticles.ts
export const useArticles = (params: ArticleSearchParams) => {
  return useQuery({
    queryKey: ['articles', params],
    queryFn: () => articleApi.getArticles(params),
    staleTime: 5 * 60 * 1000, // 5 minutes
    gcTime: 10 * 60 * 1000, // 10 minutes
  });
};

export const useCreateArticle = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: articleApi.createArticle,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['articles'] });
      toast.success('Article created successfully');
    },
    onError: (error) => {
      toast.error('Failed to create article');
    }
  });
};
```

## API Integration

### Axios Configuration
```typescript
// lib/api.ts
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api',
  timeout: 10000,
});

// Request interceptor for auth
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Response interceptor for token refresh
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      // Try to refresh token
      try {
        const refreshResponse = await api.post('/auth/refresh');
        const newToken = refreshResponse.data.token;
        localStorage.setItem('token', newToken);
        // Retry the original request
        error.config.headers.Authorization = `Bearer ${newToken}`;
        return api.request(error.config);
      } catch (refreshError) {
        // Redirect to login
        window.location.href = '/login';
      }
    }
    return Promise.reject(error);
  }
);

export default api;
```

### API Service Layer
```typescript
// services/articleApi.ts
import api from '@/lib/api';

export interface Article {
  id: number;
  name: string;
  content: string;
  categories: Category[];
  author: string;
  createdDate: string;
  isPublished: boolean;
}

export interface CreateArticleRequest {
  name: string;
  content: string;
  categoryIds: number[];
  isPublished: boolean;
  publishDate?: string;
}

export const articleApi = {
  getArticles: (params?: ArticleSearchParams) =>
    api.get<ApiResponse<Article[]>>('/articles', { params }),

  getArticle: (id: number) =>
    api.get<ApiResponse<Article>>(`/articles/${id}`),

  createArticle: (data: CreateArticleRequest) =>
    api.post<ApiResponse<Article>>('/articles', data),

  updateArticle: (id: number, data: UpdateArticleRequest) =>
    api.put<ApiResponse<Article>>(`/articles/${id}`, data),

  deleteArticle: (id: number) =>
    api.delete(`/articles/${id}`),
};
```

## Form Management

### React Hook Form with Zod Validation
```typescript
// schemas/article.ts
import { z } from 'zod';

export const createArticleSchema = z.object({
  name: z.string()
    .min(1, 'Article name is required')
    .max(1000, 'Article name cannot exceed 1000 characters'),
  content: z.string()
    .min(1, 'Article content is required'),
  categoryIds: z.array(z.number())
    .min(1, 'At least one category must be selected')
    .max(5, 'Maximum 5 categories allowed'),
  isPublished: z.boolean(),
  publishDate: z.string().optional(),
}).refine((data) => {
  if (data.isPublished && !data.publishDate) {
    return false;
  }
  return true;
}, {
  message: 'Publish date is required when publishing',
  path: ['publishDate'],
});

export type CreateArticleForm = z.infer<typeof createArticleSchema>;
```

```typescript
// components/forms/CreateArticleForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { createArticleSchema, CreateArticleForm } from '@/schemas/article';

export const CreateArticleForm = () => {
  const { register, handleSubmit, formState: { errors }, setValue, watch } = useForm<CreateArticleForm>({
    resolver: zodResolver(createArticleSchema),
  });

  const isPublished = watch('isPublished');

  const onSubmit = async (data: CreateArticleForm) => {
    try {
      await createArticleMutation.mutateAsync(data);
    } catch (error) {
      console.error('Failed to create article:', error);
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div>
        <label className="block text-sm font-medium text-gray-700">
          Article Name
        </label>
        <input
          {...register('name')}
          className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
        />
        {errors.name && (
          <p className="mt-1 text-sm text-red-600">{errors.name.message}</p>
        )}
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700">
          Content
        </label>
        <textarea
          {...register('content')}
          rows={10}
          className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
        />
        {errors.content && (
          <p className="mt-1 text-sm text-red-600">{errors.content.message}</p>
        )}
      </div>

      <div>
        <label className="flex items-center">
          <input
            type="checkbox"
            {...register('isPublished')}
            className="rounded border-gray-300"
          />
          <span className="ml-2 text-sm text-gray-700">Publish immediately</span>
        </label>
      </div>

      {isPublished && (
        <div>
          <label className="block text-sm font-medium text-gray-700">
            Publish Date
          </label>
          <input
            type="datetime-local"
            {...register('publishDate')}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          />
          {errors.publishDate && (
            <p className="mt-1 text-sm text-red-600">{errors.publishDate.message}</p>
          )}
        </div>
      )}

      <button
        type="submit"
        className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
      >
        Create Article
      </button>
    </form>
  );
};
```

## Component Architecture

### Reusable UI Components
```typescript
// components/ui/Button.tsx
import { forwardRef } from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/lib/utils';

const buttonVariants = cva(
  'inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
        outline: 'border border-input hover:bg-accent hover:text-accent-foreground',
        secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
        link: 'underline-offset-4 hover:underline text-primary',
      },
      size: {
        default: 'h-10 py-2 px-4',
        sm: 'h-9 px-3 rounded-md',
        lg: 'h-11 px-8 rounded-md',
        icon: 'h-10 w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {}

const Button = forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  }
);
Button.displayName = 'Button';

export { Button, buttonVariants };
```

### Layout Components
```typescript
// components/layouts/AdminLayout.tsx
import { useAuthStore } from '@/stores/auth';
import { Sidebar } from './Sidebar';
import { Header } from './Header';

export const AdminLayout = ({ children }: { children: React.ReactNode }) => {
  const { user } = useAuthStore();

  if (!user) {
    return <div>Loading...</div>;
  }

  return (
    <div className="flex h-screen bg-gray-100">
      <Sidebar />
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header />
        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
          {children}
        </main>
      </div>
    </div>
  );
};
```

## Rich Text Editor

### TipTap Integration
```typescript
// components/ui/RichTextEditor.tsx
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Image from '@tiptap/extension-image';
import Link from '@tiptap/extension-link';

interface RichTextEditorProps {
  content: string;
  onChange: (content: string) => void;
}

export const RichTextEditor = ({ content, onChange }: RichTextEditorProps) => {
  const editor = useEditor({
    extensions: [
      StarterKit,
      Image,
      Link.configure({
        openOnClick: false,
      }),
    ],
    content,
    onUpdate: ({ editor }) => {
      onChange(editor.getHTML());
    },
  });

  if (!editor) {
    return null;
  }

  return (
    <div className="border border-gray-300 rounded-md">
      <div className="border-b border-gray-300 p-2 flex gap-2">
        <button
          onClick={() => editor.chain().focus().toggleBold().run()}
          className={cn(
            'px-2 py-1 rounded',
            editor.isActive('bold') ? 'bg-blue-500 text-white' : 'bg-gray-200'
          )}
        >
          Bold
        </button>
        <button
          onClick={() => editor.chain().focus().toggleItalic().run()}
          className={cn(
            'px-2 py-1 rounded',
            editor.isActive('italic') ? 'bg-blue-500 text-white' : 'bg-gray-200'
          )}
        >
          Italic
        </button>
        <button
          onClick={() => editor.chain().focus().toggleHeading({ level: 2 }).run()}
          className={cn(
            'px-2 py-1 rounded',
            editor.isActive('heading', { level: 2 }) ? 'bg-blue-500 text-white' : 'bg-gray-200'
          )}
        >
          H2
        </button>
      </div>
      <EditorContent editor={editor} className="p-4 min-h-[200px]" />
    </div>
  );
};
```

## Authentication

### NextAuth.js Configuration
```typescript
// pages/api/auth/[...nextauth].ts
import NextAuth from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import { api } from '@/lib/api';

export default NextAuth({
  providers: [
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' }
      },
      async authorize(credentials) {
        try {
          const response = await api.post('/auth/login', {
            email: credentials?.email,
            password: credentials?.password,
          });

          if (response.data.success) {
            return {
              id: response.data.user.id,
              email: response.data.user.email,
              name: response.data.user.name,
              role: response.data.user.role,
            };
          }

          return null;
        } catch (error) {
          return null;
        }
      }
    })
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.role = user.role;
      }
      return token;
    },
    async session({ session, token }) {
      if (token) {
        session.user.role = token.role;
      }
      return session;
    }
  },
  pages: {
    signIn: '/auth/signin',
    error: '/auth/error',
  }
});
```

## SEO and Performance

### Metadata Configuration
```typescript
// app/articles/[id]/page.tsx
import { Metadata } from 'next';
import { articleApi } from '@/services/articleApi';

interface PageProps {
  params: { id: string };
}

export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const article = await articleApi.getArticle(parseInt(params.id));

  return {
    title: article.data.metaTitle || article.data.name,
    description: article.data.metaDescription,
    keywords: article.data.metaKeywords,
    openGraph: {
      title: article.data.name,
      description: article.data.metaDescription,
      images: [article.data.image],
    },
  };
}
```

### Static Generation
```typescript
// app/articles/[id]/page.tsx
export async function generateStaticParams() {
  const articles = await articleApi.getArticles({ pageSize: 1000 });

  return articles.data.map((article) => ({
    id: article.id.toString(),
  }));
}
```

## Testing Rules

### Unit Testing
```typescript
// __tests__/components/Button.test.tsx
import { render, screen } from '@testing-library/react';
import { Button } from '@/components/ui/Button';

describe('Button', () => {
  it('renders children correctly', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('applies correct variant classes', () => {
    render(<Button variant="destructive">Delete</Button>);
    const button = screen.getByRole('button');
    expect(button).toHaveClass('bg-destructive');
  });
});
```

### Integration Testing
```typescript
// __tests__/pages/articles/create.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { CreateArticlePage } from '@/app/(admin)/articles/create/page';

describe('Create Article Page', () => {
  it('creates article successfully', async () => {
    const user = userEvent.setup();

    render(<CreateArticlePage />);

    await user.type(screen.getByLabelText(/article name/i), 'Test Article');
    await user.type(screen.getByLabelText(/content/i), 'Test content');
    await user.click(screen.getByRole('button', { name: /create article/i }));

    await waitFor(() => {
      expect(screen.getByText('Article created successfully')).toBeInTheDocument();
    });
  });
});
```

## Performance Optimization

### Image Optimization
```typescript
// components/ui/OptimizedImage.tsx
import Image from 'next/image';

interface OptimizedImageProps {
  src: string;
  alt: string;
  width: number;
  height: number;
  priority?: boolean;
}

export const OptimizedImage = ({
  src,
  alt,
  width,
  height,
  priority = false
}: OptimizedImageProps) => {
  return (
    <Image
      src={src}
      alt={alt}
      width={width}
      height={height}
      priority={priority}
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAIAAoDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAhEAACAQMDBQAAAAAAAAAAAAABAgMABAUGIWGRkqGx0f/EABUBAQEAAAAAAAAAAAAAAAAAAAMF/8QAGhEAAgIDAAAAAAAAAAAAAAAAAAECEgMRkf/aAAwDAQACEQMRAD8AltJagyeH0AthI5xdrLcNM91BF5pX2HaH9bcfaSXWGaRmknyJckliyjqTzSlT54b6bk+h0R+IRjWjBqO6O2mhP//Z"
    />
  );
};
```

### Code Splitting
```typescript
// app/(admin)/articles/page.tsx
import dynamic from 'next/dynamic';

const ArticleList = dynamic(() => import('@/components/features/articles/ArticleList'), {
  loading: () => <div>Loading articles...</div>,
});

const ArticleFilters = dynamic(() => import('@/components/features/articles/ArticleFilters'), {
  loading: () => <div>Loading filters...</div>,
});

export default function ArticlesPage() {
  return (
    <div>
      <ArticleFilters />
      <ArticleList />
    </div>
  );
}